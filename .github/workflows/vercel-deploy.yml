name: Vercel Deployment with Approval

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Vercel CLI
        run: npm install -g vercel

      - name: Configure Vercel
        run: |
          vercel link --yes \
            --token ${{ secrets.VERCEL_TOKEN }} \
            --project ${{ secrets.VERCEL_PROJECT_ID }} \
            --org ${{ secrets.VERCEL_ORG_ID }}

      - name: Trigger Production Deployment
        id: vercel-deploy
        run: |
          DEPLOY_OUTPUT=$(vercel --prod --token ${{ secrets.VERCEL_TOKEN }})
          echo "$DEPLOY_OUTPUT"
          
          # Extract deployment URL from CLI output
          DEPLOY_URL=$(grep -o 'https://[^ ]*\.vercel\.app' <<< "$DEPLOY_OUTPUT")
          echo "deployment_url=$DEPLOY_URL" >> $GITHUB_OUTPUT

      - name: Send Approval Notification
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: ${{ secrets.SMTP_SERVER }}
          server_port: ${{ secrets.SMTP_PORT }}
          username: ${{ secrets.SMTP_USERNAME }}
          password: ${{ secrets.SMTP_PASSWORD }}
          subject: "ðŸ”„ Vercel Deployment Approval Required - ${{ github.repository }}"
          body: |
            A production deployment is awaiting approval in Vercel.

            Details:
            - Repository: ${{ github.repository }}
            - Branch: ${{ github.ref_name }}
            - Commit: ${{ github.sha }}
            - Triggered by: ${{ github.actor }}
            - Deployment URL: ${{ steps.vercel-deploy.outputs.deployment_url }}

            Approve or reject in Vercel Dashboard:
            https://vercel.com/${{ secrets.VERCEL_ORG_ID }}/${{ secrets.VERCEL_PROJECT_ID }}

            Commit details:
            ${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }}
          to: ${{ secrets.APPROVER_EMAILS }}
          from: "GitHub Actions <${{ secrets.SMTP_USERNAME }}>"

      - name: Monitor Deployment (Optional)
        if: always()
        run: |
          echo "Deployment processing - actual status must be checked in Vercel Dashboard"