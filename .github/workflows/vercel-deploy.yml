name: Vercel Deployment with Approval

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Vercel CLI
        run: npm install -g vercel

      - name: Link Vercel Project
        run: vercel link --yes --token ${{ secrets.VERCEL_TOKEN }}

      - name: Trigger Production Deployment
        id: vercel-deploy
        run: |
          DEPLOY_OUTPUT=$(vercel --prod --token ${{ secrets.VERCEL_TOKEN }})
          echo "$DEPLOY_OUTPUT"
          
          DEPLOY_URL=$(grep -o 'https://[^ ]*\.vercel\.app' <<< "$DEPLOY_OUTPUT")
          echo "deployment_url=$DEPLOY_URL" >> $GITHUB_OUTPUT

      - name: Send Approval Notification
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: ${{ secrets.SMTP_SERVER }}
          server_port: ${{ secrets.SMTP_PORT }}
          username: ${{ secrets.SMTP_USERNAME }}
          password: ${{ secrets.SMTP_PASSWORD }}
          subject: "üîÑ Vercel Deployment Approval Required - ${{ github.repository }}"
          body: |
            A production deployment is awaiting approval in Vercel.

            üì¶ Repository: ${{ github.repository }}
            üîÄ Branch: ${{ github.ref_name }}
            üî¢ Commit: ${{ github.sha }}
            üë§ Triggered by: ${{ github.actor }}
            üåê Deployment URL: ${{ steps.vercel-deploy.outputs.deployment_url }}

            ‚úÖ Approve or reject in Vercel Dashboard:
            https://vercel.com/${{ secrets.VERCEL_ORG_ID }}/${{ secrets.VERCEL_PROJECT_ID }}

            üîç Commit details:
            ${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }}
          to: ${{ secrets.APPROVER_EMAILS }}
          from: "GitHub Actions <${{ secrets.SMTP_USERNAME }}>"

      - name: Monitor Deployment (Optional)
        if: always()
        run: echo "Deployment triggered. Check status in Vercel Dashboard."
