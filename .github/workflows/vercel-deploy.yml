name: Vercel Deployment with Approval

on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      approved:
        description: 'Confirm deployment approval (enter "yes" to proceed)'
        required: true
        default: 'yes'

jobs:
  notify-approvers:
    if: github.event_name == 'push'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code (non-triggering)
        uses: actions/checkout@v4
        with:
          persist-credentials: false  # Prevent Vercel auto-deploy

      - name: Send Approval Requests
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: ${{ secrets.SMTP_SERVER }}
          server_port: ${{ secrets.SMTP_PORT }}
          username: ${{ secrets.SMTP_USERNAME }}
          password: ${{ secrets.SMTP_PASSWORD }}
          subject: "üîÑ Deployment Approval Required - ${{ github.repository }}"
          body: |
            A new deployment is ready for review.

            Repository: ${{ github.repository }}
            Branch: ${{ github.ref_name }}
            Commit: ${{ github.sha }}
            Triggered by: ${{ github.actor }}

            To approve deployment, please manually trigger the deployment workflow via the GitHub Actions UI.
            
            For more details, view the commit:
            ${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }}
          to: ${{ secrets.APPROVER_EMAIL_1 }},${{ secrets.APPROVER_EMAIL_2 }}
          from: "GitHub Actions <${{ secrets.SMTP_USERNAME }}>"

  deploy:
    if: github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Trigger Vercel Deployment
        id: deploy
        run: |
          echo "Triggering deployment..."
          DEPLOY_RESPONSE=$(curl -s -X POST "${{ secrets.VERCEL_DEPLOY_HOOK }}")
          echo "Deploy response: $DEPLOY_RESPONSE"
          
          if [[ "$DEPLOY_RESPONSE" == *"deploymentId"* ]]; then
            echo "‚úÖ Deployment triggered successfully"
          else
            echo "‚ùå Failed to trigger deployment. Response: $DEPLOY_RESPONSE"
            exit 1
          fi

      - name: Wait for Deployment Completion
        uses: fountainhead/action-wait-for-check@v1.1.0
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          ref: ${{ github.sha }}
          check-name: 'Vercel'

      - name: Send Success Notifications
        if: success()
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: ${{ secrets.SMTP_SERVER }}
          server_port: ${{ secrets.SMTP_PORT }}
          username: ${{ secrets.SMTP_USERNAME }}
          password: ${{ secrets.SMTP_PASSWORD }}
          subject: "‚úÖ Deployment Successful - ${{ github.repository }}"
          body: |
            Deployment completed successfully!

            Details:
            ‚Ä¢ Repository: ${{ github.repository }}
            ‚Ä¢ Branch: ${{ github.ref_name }}
            ‚Ä¢ Commit: ${{ github.sha }}
            ‚Ä¢ Deployment URL: ${{ secrets.VERCEL_APP_URL }}

            View deployment: ${{ secrets.VERCEL_APP_URL }}
            View changes: ${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }}
          to: ${{ secrets.APPROVER_EMAIL_1 }},${{ secrets.APPROVER_EMAIL_2 }}
          from: "GitHub Actions <${{ secrets.SMTP_USERNAME }}"
